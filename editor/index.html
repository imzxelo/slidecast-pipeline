<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slide Sync Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: #16213e;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #0f3460;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #e94560;
    }
    .file-inputs {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .file-inputs label {
      background: #0f3460;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    .file-inputs label:hover {
      background: #1a4a7a;
    }
    .file-inputs input[type="file"] {
      display: none;
    }
    .file-name {
      font-size: 12px;
      color: #888;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .left-panel {
      width: 180px;
      background: #16213e;
      border-right: 1px solid #0f3460;
      overflow-y: auto;
      padding: 12px;
    }
    .thumbnail {
      background: #0f3460;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      overflow: hidden;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }
    .thumbnail.active {
      border-color: #e94560;
    }
    .thumbnail canvas {
      width: 100%;
      display: block;
    }
    .thumbnail-label {
      text-align: center;
      padding: 4px;
      font-size: 11px;
      color: #aaa;
    }
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1a1a2e;
    }
    .slide-view {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }
    .slide-view canvas {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .audio-controls {
      background: #16213e;
      padding: 16px 20px;
      border-top: 1px solid #0f3460;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #888;
      margin-bottom: 8px;
    }
    .progress-container {
      position: relative;
      height: 40px;
      background: #0f3460;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .marker-indicator {
      position: absolute;
      top: 0;
      width: 3px;
      height: 100%;
      background: #4ade80;
      transform: translateX(-50%);
    }
    .playback-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .play-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e94560;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
    }
    .play-btn:hover {
      transform: scale(1.05);
    }
    .play-btn:active {
      transform: scale(0.95);
    }
    .play-btn svg {
      fill: white;
      width: 20px;
      height: 20px;
    }
    .speed-control {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .speed-control select {
      background: #0f3460;
      color: #eee;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .right-panel {
      width: 320px;
      background: #16213e;
      border-left: 1px solid #0f3460;
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #0f3460;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-header h2 {
      font-size: 14px;
      font-weight: 600;
    }
    .panel-actions {
      display: flex;
      gap: 8px;
    }
    .panel-actions button {
      background: #0f3460;
      border: none;
      color: #eee;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .panel-actions button:hover {
      background: #1a4a7a;
    }
    .panel-actions button.primary {
      background: #e94560;
    }
    .panel-actions button.primary:hover {
      background: #ff6b6b;
    }
    .markers-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .marker-item {
      background: #0f3460;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .marker-item.current {
      border-left: 3px solid #4ade80;
    }
    .marker-time {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      color: #4ade80;
      min-width: 70px;
    }
    .marker-slide {
      font-size: 13px;
      flex: 1;
    }
    .marker-actions {
      display: flex;
      gap: 6px;
    }
    .marker-actions button {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: color 0.2s, background 0.2s;
    }
    .marker-actions button:hover {
      color: #eee;
      background: rgba(255,255,255,0.1);
    }
    .marker-actions button.delete:hover {
      color: #e94560;
    }
    .add-marker-btn {
      margin: 12px;
      padding: 12px;
      background: #4ade80;
      color: #1a1a2e;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .add-marker-btn:hover {
      background: #22c55e;
    }
    .keyboard-hint {
      padding: 12px 16px;
      background: #0f3460;
      font-size: 11px;
      color: #888;
      border-top: 1px solid #1a4a7a;
    }
    .keyboard-hint kbd {
      background: #16213e;
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 4px;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .empty-state p {
      margin-bottom: 8px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #16213e;
      padding: 24px;
      border-radius: 12px;
      min-width: 300px;
    }
    .modal-content h3 {
      margin-bottom: 16px;
    }
    .modal-content label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #aaa;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      background: #0f3460;
      border: 1px solid #1a4a7a;
      border-radius: 6px;
      color: #eee;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-buttons .cancel {
      background: #0f3460;
      color: #eee;
    }
    .modal-buttons .save {
      background: #4ade80;
      color: #1a1a2e;
    }
  </style>
</head>
<body>
  <header>
    <h1>Slide Sync Editor</h1>
    <div class="file-inputs">
      <label>
        PDF
        <input type="file" id="pdfInput" accept=".pdf">
      </label>
      <span class="file-name" id="pdfName">-</span>
      <label>
        Audio
        <input type="file" id="audioInput" accept="audio/*">
      </label>
      <span class="file-name" id="audioName">-</span>
    </div>
  </header>

  <div class="main-container">
    <div class="left-panel" id="thumbnails">
      <div class="empty-state">
        <p>PDFを読み込んでください</p>
      </div>
    </div>

    <div class="center-panel">
      <div class="slide-view">
        <canvas id="slideCanvas"></canvas>
      </div>
      <div class="audio-controls">
        <div class="time-display">
          <span id="currentTime">0:00.000</span>
          <span id="duration">0:00.000</span>
        </div>
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="playback-controls">
          <button class="play-btn" id="playBtn">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          </button>
          <div class="speed-control">
            <span>Speed:</span>
            <select id="speedSelect">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-header">
        <h2>Markers</h2>
        <div class="panel-actions">
          <button id="importBtn">Import</button>
          <button id="exportBtn" class="primary">Export</button>
        </div>
      </div>
      <div class="markers-list" id="markersList">
        <div class="empty-state">
          <p>マーカーがありません</p>
          <p>Mキーでマーカーを追加</p>
        </div>
      </div>
      <button class="add-marker-btn" id="addMarkerBtn">+ マーカーを追加 (M)</button>
      <div class="keyboard-hint">
        <kbd>Space</kbd> 再生/停止
        <kbd>M</kbd> マーカー追加
        <kbd>←/→</kbd> 5秒シーク
        <kbd>↑/↓</kbd> スライド切替
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>マーカーを編集</h3>
      <label>時間 (秒)</label>
      <input type="number" id="editTime" step="0.001" min="0">
      <label>スライド番号</label>
      <input type="number" id="editSlide" step="1" min="1">
      <div class="modal-buttons">
        <button class="cancel" id="editCancel">キャンセル</button>
        <button class="save" id="editSave">保存</button>
      </div>
    </div>
  </div>

  <input type="file" id="importInput" accept=".json" style="display:none">

  <audio id="audioPlayer"></audio>

  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // State
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let markers = [];
    let editingMarkerIndex = -1;

    // DOM Elements
    const pdfInput = document.getElementById('pdfInput');
    const audioInput = document.getElementById('audioInput');
    const pdfName = document.getElementById('pdfName');
    const audioName = document.getElementById('audioName');
    const thumbnails = document.getElementById('thumbnails');
    const slideCanvas = document.getElementById('slideCanvas');
    const audioPlayer = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const speedSelect = document.getElementById('speedSelect');
    const markersList = document.getElementById('markersList');
    const addMarkerBtn = document.getElementById('addMarkerBtn');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const editModal = document.getElementById('editModal');
    const editTime = document.getElementById('editTime');
    const editSlide = document.getElementById('editSlide');
    const editCancel = document.getElementById('editCancel');
    const editSave = document.getElementById('editSave');

    // Format time
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toFixed(3).padStart(6, '0')}`;
    }

    // Load PDF
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      pdfName.textContent = file.name;
      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      totalPages = pdfDoc.numPages;

      renderThumbnails();
      renderPage(1);
    });

    // Render thumbnails
    async function renderThumbnails() {
      thumbnails.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 0.3 });

        const div = document.createElement('div');
        div.className = 'thumbnail' + (i === currentPage ? ' active' : '');
        div.dataset.page = i;

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;

        const label = document.createElement('div');
        label.className = 'thumbnail-label';
        label.textContent = `Slide ${i}`;

        div.appendChild(canvas);
        div.appendChild(label);
        div.addEventListener('click', () => {
          currentPage = i;
          renderPage(i);
          updateThumbnailSelection();
        });

        thumbnails.appendChild(div);
      }
    }

    // Update thumbnail selection
    function updateThumbnailSelection() {
      document.querySelectorAll('.thumbnail').forEach((el, idx) => {
        el.classList.toggle('active', idx + 1 === currentPage);
      });
    }

    // Render page
    async function renderPage(pageNum) {
      if (!pdfDoc) return;

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1.5 });

      slideCanvas.width = viewport.width;
      slideCanvas.height = viewport.height;

      const ctx = slideCanvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;
    }

    // Load audio
    audioInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      audioName.textContent = file.name;
      audioPlayer.src = URL.createObjectURL(file);
    });

    // Audio events
    audioPlayer.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audioPlayer.duration);
      renderMarkerIndicators();
    });

    audioPlayer.addEventListener('timeupdate', () => {
      const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progressBar.style.width = `${progress}%`;
      currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      updateCurrentMarker();
    });

    audioPlayer.addEventListener('play', () => {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    });

    audioPlayer.addEventListener('pause', () => {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    });

    // Play/Pause
    playBtn.addEventListener('click', togglePlay);

    function togglePlay() {
      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    }

    // Speed
    speedSelect.addEventListener('change', () => {
      audioPlayer.playbackRate = parseFloat(speedSelect.value);
    });

    // Progress seek
    progressContainer.addEventListener('click', (e) => {
      if (!audioPlayer.duration) return;
      const rect = progressContainer.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      audioPlayer.currentTime = ratio * audioPlayer.duration;
    });

    // Add marker
    function addMarker() {
      if (!audioPlayer.duration || !totalPages) {
        alert('PDFと音声を先に読み込んでください');
        return;
      }

      const marker = {
        t: audioPlayer.currentTime,
        slide: currentPage
      };

      markers.push(marker);
      markers.sort((a, b) => a.t - b.t);
      renderMarkers();
      renderMarkerIndicators();
    }

    addMarkerBtn.addEventListener('click', addMarker);

    // Render markers list
    function renderMarkers() {
      if (markers.length === 0) {
        markersList.innerHTML = '<div class="empty-state"><p>マーカーがありません</p><p>Mキーでマーカーを追加</p></div>';
        return;
      }

      markersList.innerHTML = markers.map((m, i) => `
        <div class="marker-item" data-index="${i}">
          <span class="marker-time">${formatTime(m.t)}</span>
          <span class="marker-slide">Slide ${m.slide}</span>
          <div class="marker-actions">
            <button class="edit" title="編集" onclick="openEditModal(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <button class="goto" title="移動" onclick="gotoMarker(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="delete" title="削除" onclick="deleteMarker(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Render marker indicators on progress bar
    function renderMarkerIndicators() {
      document.querySelectorAll('.marker-indicator').forEach(el => el.remove());

      if (!audioPlayer.duration) return;

      markers.forEach(m => {
        const indicator = document.createElement('div');
        indicator.className = 'marker-indicator';
        indicator.style.left = `${(m.t / audioPlayer.duration) * 100}%`;
        progressContainer.appendChild(indicator);
      });
    }

    // Update current marker highlight
    function updateCurrentMarker() {
      const currentTime = audioPlayer.currentTime;
      document.querySelectorAll('.marker-item').forEach((el, i) => {
        const marker = markers[i];
        const nextMarker = markers[i + 1];
        const isCurrent = marker && currentTime >= marker.t && (!nextMarker || currentTime < nextMarker.t);
        el.classList.toggle('current', isCurrent);
      });
    }

    // Go to marker
    window.gotoMarker = function(index) {
      const marker = markers[index];
      if (!marker) return;
      audioPlayer.currentTime = marker.t;
      currentPage = marker.slide;
      renderPage(currentPage);
      updateThumbnailSelection();
    };

    // Delete marker
    window.deleteMarker = function(index) {
      markers.splice(index, 1);
      renderMarkers();
      renderMarkerIndicators();
    };

    // Edit modal
    window.openEditModal = function(index) {
      editingMarkerIndex = index;
      const marker = markers[index];
      editTime.value = marker.t.toFixed(3);
      editSlide.value = marker.slide;
      editSlide.max = totalPages;
      editModal.classList.add('active');
    };

    editCancel.addEventListener('click', () => {
      editModal.classList.remove('active');
      editingMarkerIndex = -1;
    });

    editSave.addEventListener('click', () => {
      if (editingMarkerIndex < 0) return;

      const t = parseFloat(editTime.value);
      const slide = parseInt(editSlide.value);

      if (isNaN(t) || t < 0 || t > audioPlayer.duration) {
        alert('無効な時間です');
        return;
      }
      if (isNaN(slide) || slide < 1 || slide > totalPages) {
        alert('無効なスライド番号です');
        return;
      }

      markers[editingMarkerIndex] = { t, slide };
      markers.sort((a, b) => a.t - b.t);

      editModal.classList.remove('active');
      editingMarkerIndex = -1;
      renderMarkers();
      renderMarkerIndicators();
    });

    // Export
    exportBtn.addEventListener('click', () => {
      if (markers.length === 0) {
        alert('エクスポートするマーカーがありません');
        return;
      }

      const data = { markers: markers };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'markers.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import
    importBtn.addEventListener('click', () => {
      importInput.click();
    });

    importInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data.markers || !Array.isArray(data.markers)) {
          throw new Error('Invalid markers.json format');
        }

        markers = data.markers.map(m => ({
          t: Number(m.t),
          slide: Number(m.slide)
        })).filter(m => !isNaN(m.t) && !isNaN(m.slide) && m.t >= 0 && m.slide >= 1);

        markers.sort((a, b) => a.t - b.t);
        renderMarkers();
        renderMarkerIndicators();
      } catch (err) {
        alert('JSONの読み込みに失敗しました: ' + err.message);
      }

      importInput.value = '';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      switch (e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          togglePlay();
          break;
        case 'm':
          e.preventDefault();
          addMarker();
          break;
        case 'arrowleft':
          e.preventDefault();
          audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
          break;
        case 'arrowright':
          e.preventDefault();
          audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
          break;
        case 'arrowup':
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            updateThumbnailSelection();
          }
          break;
        case 'arrowdown':
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            updateThumbnailSelection();
          }
          break;
      }
    });

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && editModal.classList.contains('active')) {
        editModal.classList.remove('active');
        editingMarkerIndex = -1;
      }
    });
  </script>
</body>
</html>

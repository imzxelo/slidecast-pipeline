<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slide Sync Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f3f0;
      color: #2c2c2c;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
      padding: 16px 28px;
      display: flex;
      align-items: center;
      gap: 24px;
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }
    header h1 {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
    }
    header h1::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 22px;
      background: #c9a227;
      margin-right: 12px;
      vertical-align: middle;
    }
    .file-inputs {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-left: auto;
    }
    .file-inputs label {
      background: rgba(255,255,255,0.15);
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.2s;
    }
    .file-inputs label:hover {
      background: rgba(255,255,255,0.25);
      border-color: #c9a227;
    }
    .file-inputs input[type="file"] {
      display: none;
    }
    .file-name {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .left-panel {
      width: 200px;
      background: #fff;
      border-right: 1px solid #e0dcd5;
      overflow-y: auto;
      padding: 16px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }
    .panel-title {
      font-size: 13px;
      font-weight: 700;
      color: #1e3a5f;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #c9a227;
    }
    .thumbnail {
      background: #fff;
      border-radius: 4px;
      margin-bottom: 12px;
      cursor: pointer;
      overflow: hidden;
      border: 2px solid #e0dcd5;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .thumbnail:hover {
      border-color: #1e3a5f;
    }
    .thumbnail.active {
      border-color: #c9a227;
      box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
    }
    .thumbnail canvas {
      width: 100%;
      display: block;
    }
    .thumbnail-label {
      text-align: center;
      padding: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #4a4a4a;
      background: #f8f6f3;
    }
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #eae6e1;
    }
    .slide-view {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: hidden;
    }
    .slide-view canvas {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      border: 1px solid #d0ccc5;
    }
    .audio-controls {
      background: #fff;
      padding: 20px 28px;
      border-top: 1px solid #e0dcd5;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 500;
      color: #1e3a5f;
      margin-bottom: 10px;
      font-family: 'SF Mono', Monaco, monospace;
    }
    .progress-container {
      position: relative;
      height: 12px;
      background: #e8e4df;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 16px;
      border: 1px solid #d0ccc5;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #1e3a5f, #2d5a8f);
      border-radius: 6px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .marker-indicator {
      position: absolute;
      top: -2px;
      width: 4px;
      height: 16px;
      background: #c9a227;
      border-radius: 2px;
      transform: translateX(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .playback-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .play-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.4);
    }
    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(30, 58, 95, 0.5);
    }
    .play-btn:active {
      transform: scale(0.98);
    }
    .play-btn svg {
      fill: white;
      width: 22px;
      height: 22px;
    }
    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #4a4a4a;
    }
    .speed-control select {
      background: #f8f6f3;
      color: #2c2c2c;
      border: 1px solid #d0ccc5;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .speed-control select:focus {
      outline: none;
      border-color: #1e3a5f;
    }
    .right-panel {
      width: 340px;
      background: #fff;
      border-left: 1px solid #e0dcd5;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 8px rgba(0,0,0,0.05);
    }
    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0dcd5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f6f3;
    }
    .panel-header h2 {
      font-size: 15px;
      font-weight: 700;
      color: #1e3a5f;
      letter-spacing: 0.5px;
    }
    .panel-header h2::before {
      content: '';
      display: inline-block;
      width: 3px;
      height: 15px;
      background: #c9a227;
      margin-right: 10px;
      vertical-align: middle;
    }
    .panel-actions {
      display: flex;
      gap: 8px;
    }
    .panel-actions button {
      background: #fff;
      border: 1px solid #d0ccc5;
      color: #4a4a4a;
      padding: 8px 14px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .panel-actions button:hover {
      border-color: #1e3a5f;
      color: #1e3a5f;
    }
    .panel-actions button.primary {
      background: #1e3a5f;
      border-color: #1e3a5f;
      color: #fff;
    }
    .panel-actions button.primary:hover {
      background: #2d4a6f;
    }
    .markers-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .marker-item {
      background: #f8f6f3;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid #e8e4df;
      transition: all 0.2s;
    }
    .marker-item:hover {
      border-color: #d0ccc5;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .marker-item.current {
      border-left: 4px solid #c9a227;
      background: #fffdf8;
    }
    .marker-thumb {
      width: 50px;
      height: 38px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #d0ccc5;
      flex-shrink: 0;
    }
    .marker-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    .marker-time {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      font-weight: 600;
      color: #1e3a5f;
    }
    .marker-slide {
      font-size: 12px;
      font-weight: 500;
      color: #888;
    }
    .marker-actions {
      display: flex;
      gap: 6px;
    }
    .marker-actions button {
      background: transparent;
      border: 1px solid transparent;
      color: #888;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .marker-actions button:hover {
      color: #1e3a5f;
      background: #f0ece7;
      border-color: #e0dcd5;
    }
    .marker-actions button.delete:hover {
      color: #c0392b;
      background: #fdf2f2;
      border-color: #f5c6cb;
    }
    /* æ‰‹å‹•ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆå°ã•ã‚ï¼‰ */
    .add-marker-btn-small {
      margin: 8px 16px;
      padding: 10px;
      background: #f8f6f3;
      color: #666;
      border: 1px dashed #ccc;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .add-marker-btn-small:hover {
      background: #f0ece7;
      border-color: #999;
      color: #333;
    }
    /* AIè‡ªå‹•ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç›®ç«‹ã¤ä½ç½®ï¼‰ */
    .auto-generate-section {
      margin: 16px;
      padding: 16px;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%);
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(30, 58, 95, 0.3);
    }
    .auto-generate-btn-main {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, #c9a227 0%, #e0b82e 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(201, 162, 39, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .auto-generate-btn-main:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201, 162, 39, 0.5);
    }
    .auto-generate-btn-main:disabled {
      background: #6b7c8f;
      cursor: not-allowed;
      box-shadow: none;
    }
    .auto-generate-btn-main .btn-icon {
      font-size: 18px;
    }
    .auto-generate-btn-main.loading {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .auto-status {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
    }
    .auto-status.ready {
      color: #90EE90;
    }
    .auto-status.error {
      color: #ff8080;
    }
    .auto-progress {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .progress-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: all 0.3s;
    }
    .progress-item.waiting {
      opacity: 0.5;
    }
    .progress-item.processing {
      background: rgba(255, 200, 50, 0.2);
      animation: processingPulse 1.5s infinite;
    }
    @keyframes processingPulse {
      0%, 100% { background: rgba(255, 200, 50, 0.2); }
      50% { background: rgba(255, 200, 50, 0.35); }
    }
    .progress-item.done {
      color: #90EE90;
      background: rgba(144, 238, 144, 0.15);
      opacity: 1;
    }
    .progress-item.error {
      color: #ff8080;
      background: rgba(255, 128, 128, 0.15);
      opacity: 1;
    }
    .progress-icon {
      font-size: 16px;
    }
    .progress-text {
      flex: 1;
    }
    /* æ—§ã‚¹ã‚¿ã‚¤ãƒ«äº’æ› */
    .step-number {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #d0e3f7;
      color: #1e3a5f;
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .step-number.done {
      background: #4ade80;
      color: #fff;
    }
    .step-btn {
      flex: 1;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid #d0e3f7;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #1e3a5f;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .step-btn:hover:not(:disabled) {
      border-color: #1e3a5f;
      background: #f8fafd;
    }
    .step-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .step-btn.done {
      background: #f0fdf4;
      border-color: #4ade80;
      color: #166534;
    }
    .step-btn.loading {
      position: relative;
      color: transparent;
    }
    .step-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid #d0e3f7;
      border-top-color: #1e3a5f;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .auto-generate-btn {
      margin-top: 12px;
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .auto-generate-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    .auto-generate-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .auto-generate-btn.loading {
      position: relative;
      color: transparent;
    }
    .auto-generate-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 18px;
      height: 18px;
      margin: -9px 0 0 -9px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .auto-marker-status {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }
    .auto-marker-status.success {
      color: #166534;
    }
    .auto-marker-status.error {
      color: #dc2626;
    }
    .generate-btn {
      margin: 8px 16px 16px 16px;
      padding: 16px;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.4);
      letter-spacing: 1px;
    }
    .generate-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(30, 58, 95, 0.5);
    }
    .generate-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .generate-btn.loading {
      position: relative;
      color: transparent;
    }
    .generate-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .keyboard-hint {
      padding: 14px 20px;
      background: #f8f6f3;
      font-size: 12px;
      color: #6a6a6a;
      border-top: 1px solid #e8e4df;
      line-height: 1.8;
    }
    .keyboard-hint kbd {
      background: #fff;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #d0ccc5;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      font-weight: 600;
      color: #1e3a5f;
      margin-right: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    .empty-state p {
      margin-bottom: 8px;
      font-size: 14px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 58, 95, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      padding: 28px;
      border-radius: 8px;
      min-width: 340px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
      margin-bottom: 20px;
      color: #1e3a5f;
      font-size: 18px;
      font-weight: 700;
    }
    .modal-content h3::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 18px;
      background: #c9a227;
      margin-right: 12px;
      vertical-align: middle;
    }
    .modal-content label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #4a4a4a;
    }
    .modal-content input {
      width: 100%;
      padding: 12px;
      background: #f8f6f3;
      border: 1px solid #d0ccc5;
      border-radius: 4px;
      color: #2c2c2c;
      font-size: 15px;
      margin-bottom: 20px;
    }
    .modal-content input:focus {
      outline: none;
      border-color: #1e3a5f;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .modal-buttons .cancel {
      background: #f8f6f3;
      color: #4a4a4a;
      border: 1px solid #d0ccc5;
    }
    .modal-buttons .cancel:hover {
      background: #f0ece7;
    }
    .modal-buttons .save {
      background: #1e3a5f;
      color: #fff;
    }
    .modal-buttons .save:hover {
      background: #2d4a6f;
    }
    /* Loading Modal */
    .loading-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 58, 95, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      flex-direction: column;
    }
    .loading-modal.active {
      display: flex;
    }
    .loading-container {
      text-align: center;
      color: #fff;
    }
    .loading-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    .crane-game {
      width: 300px;
      height: 250px;
      position: relative;
      margin: 0 auto 30px;
    }
    .crane-arm {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 60px;
      background: #c9a227;
      animation: craneMove 2s ease-in-out infinite;
    }
    .crane-arm::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 15px;
      border: 3px solid #c9a227;
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .box-container {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 150px;
      border: 4px solid #c9a227;
      border-top: none;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
    }
    .boxes {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-content: flex-end;
      gap: 4px;
      padding: 4px;
    }
    .box {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #c9a227, #d4b03a);
      border-radius: 4px;
      animation: boxDrop 0.5s ease-out forwards;
      opacity: 0;
    }
    @keyframes craneMove {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(30px); }
    }
    @keyframes boxDrop {
      0% { transform: translateY(-100px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .loading-progress {
      font-size: 48px;
      font-weight: 700;
      color: #c9a227;
      margin-bottom: 10px;
    }
    .loading-status {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }
    .loading-toggle {
      margin-top: 30px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .loading-toggle button {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .loading-toggle button:hover {
      background: rgba(255,255,255,0.2);
    }
    .loading-toggle button.active {
      background: #c9a227;
      border-color: #c9a227;
      color: #1e3a5f;
    }
    /* AI Assistant Panel */
    .ai-panel {
      display: none;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      width: 100%;
      padding: 0 20px;
    }
    .ai-panel.active {
      display: flex;
    }
    .ai-status {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 15px;
      text-align: center;
    }
    .ai-status.analyzed {
      color: #4ade80;
    }
    .ai-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .ai-btn {
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .ai-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: #c9a227;
    }
    .ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .ai-btn.ai-analyze {
      background: rgba(74, 222, 128, 0.2);
      border-color: #4ade80;
    }
    .ai-btn.ai-analyze:hover {
      background: rgba(74, 222, 128, 0.3);
    }
    .ai-btn.ai-analyze.done {
      background: rgba(74, 222, 128, 0.4);
      color: #4ade80;
    }
    .ai-btn.loading {
      position: relative;
      color: transparent;
    }
    .ai-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .ai-result {
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 20px;
      text-align: left;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .ai-result:empty {
      display: none;
    }
    .ai-result h4 {
      color: #c9a227;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .ai-copy-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #c9a227;
      border: none;
      color: #1e3a5f;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .ai-copy-btn:hover {
      background: #d4b03a;
    }
  </style>
</head>
<body>
  <header>
    <h1>Slide Sync Editor</h1>
    <div class="file-inputs">
      <label>
        PDF ã‚’é¸æŠ
        <input type="file" id="pdfInput" accept=".pdf">
      </label>
      <span class="file-name" id="pdfName">æœªé¸æŠ</span>
      <label>
        éŸ³å£°ã‚’é¸æŠ
        <input type="file" id="audioInput" accept="audio/*">
      </label>
      <span class="file-name" id="audioName">æœªé¸æŠ</span>
    </div>
  </header>

  <div class="main-container">
    <div class="left-panel">
      <div class="panel-title">ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€è¦§</div>
      <div id="thumbnails">
        <div class="empty-state">
          <p>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’</p>
          <p>èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
        </div>
      </div>
    </div>

    <div class="center-panel">
      <div class="slide-view">
        <canvas id="slideCanvas"></canvas>
      </div>
      <div class="audio-controls">
        <div class="time-display">
          <span id="currentTime">0:00.000</span>
          <span id="duration">0:00.000</span>
        </div>
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="playback-controls">
          <button class="play-btn" id="playBtn">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          </button>
          <div class="speed-control">
            <span>å†ç”Ÿé€Ÿåº¦:</span>
            <select id="speedSelect">
              <option value="0.5">0.5å€</option>
              <option value="0.75">0.75å€</option>
              <option value="1" selected>1å€ï¼ˆæ¨™æº–ï¼‰</option>
              <option value="1.25">1.25å€</option>
              <option value="1.5">1.5å€</option>
              <option value="2">2å€</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-header">
        <h2>ãƒãƒ¼ã‚«ãƒ¼</h2>
        <div class="panel-actions">
          <button id="importBtn">èª­ã¿è¾¼ã¿</button>
          <button id="exportBtn" class="primary">ä¿å­˜</button>
        </div>
      </div>
      <!-- AIè‡ªå‹•ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆç›®ç«‹ã¤ä½ç½®ã«é…ç½®ï¼‰ -->
      <div class="auto-generate-section">
        <button class="auto-generate-btn-main" id="autoGenerateBtn" disabled>
          <span class="btn-icon">âœ¨</span>
          ãƒãƒ¼ã‚«ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆAIï¼‰
        </button>
        <div class="auto-status" id="autoMarkerStatus">ğŸ“‚ PDFã¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="auto-progress" id="autoProgress">
          <div class="progress-item waiting" id="pdfProgress">
            <span class="progress-icon" id="pdfProgressIcon">ğŸ“„</span>
            <span class="progress-text" id="pdfProgressText">PDFã‚’å¾…æ©Ÿä¸­...</span>
          </div>
          <div class="progress-item waiting" id="audioProgress">
            <span class="progress-icon" id="audioProgressIcon">ğŸµ</span>
            <span class="progress-text" id="audioProgressText">éŸ³å£°ã‚’å¾…æ©Ÿä¸­...</span>
          </div>
        </div>
      </div>

      <div class="markers-list" id="markersList">
        <div class="empty-state">
          <p>ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p>ä¸Šã®ãƒœã‚¿ãƒ³ã§è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‹ã€Mã‚­ãƒ¼ã§æ‰‹å‹•è¿½åŠ </p>
        </div>
      </div>
      <button class="add-marker-btn-small" id="addMarkerBtn">ï¼‹ æ‰‹å‹•ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ </button>
      <button class="generate-btn" id="generateBtn">å‹•ç”»ã‚’ç”Ÿæˆ</button>
      <div class="keyboard-hint">
        <kbd>Space</kbd> å†ç”Ÿ/åœæ­¢
        <kbd>M</kbd> ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        <kbd>â†</kbd><kbd>â†’</kbd> 5ç§’ç§»å‹•
        <kbd>â†‘</kbd><kbd>â†“</kbd> ã‚¹ãƒ©ã‚¤ãƒ‰åˆ‡æ›¿
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>ãƒãƒ¼ã‚«ãƒ¼ã‚’ç·¨é›†</h3>
      <label>æ™‚é–“ï¼ˆç§’ï¼‰</label>
      <input type="number" id="editTime" step="0.001" min="0">
      <label>ã‚¹ãƒ©ã‚¤ãƒ‰ç•ªå·</label>
      <input type="number" id="editSlide" step="1" min="1">
      <div class="modal-buttons">
        <button class="cancel" id="editCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="save" id="editSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <input type="file" id="importInput" accept=".json" style="display:none">

  <!-- Loading Modal -->
  <div class="loading-modal" id="loadingModal">
    <div class="loading-container" id="loadingAnimation">
      <div class="loading-title">å‹•ç”»ã‚’ç”Ÿæˆä¸­...</div>
      <div class="crane-game">
        <div class="crane-arm"></div>
        <div class="box-container">
          <div class="boxes" id="boxes"></div>
        </div>
      </div>
      <div class="loading-progress" id="loadingProgress">0%</div>
      <div class="loading-status" id="loadingStatus">æº–å‚™ä¸­...</div>
    </div>

    <div class="ai-panel" id="aiPanel">
      <div class="loading-title">å¾…ã¡æ™‚é–“ã‚’æœ‰åŠ¹æ´»ç”¨</div>
      <div class="ai-status" id="aiStatus">PDFã‚’åˆ†æã™ã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™</div>
      <div class="ai-buttons">
        <button class="ai-btn ai-analyze" id="aiAnalyzeBtn">PDFåˆ†æï¼ˆGeminiï¼‰</button>
        <button class="ai-btn" id="aiSummaryBtn">æ¦‚è¦æ¬„ã‚’ç”Ÿæˆ</button>
        <button class="ai-btn" id="aiKeyPointsBtn">ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆæŠ½å‡º</button>
        <button class="ai-btn" id="aiQuizBtn">ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆ</button>
      </div>
      <div class="ai-result" id="aiResult"></div>
      <button class="ai-copy-btn" id="aiCopyBtn" style="display:none">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="loading-toggle">
      <button id="toggleAnimation" class="active">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
      <button id="toggleAI">AIæ”¯æ´</button>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // State
    let pdfDoc = null;
    let pdfFile = null;
    let audioFile = null;
    let currentPage = 1;
    let totalPages = 0;
    let markers = [];
    let editingMarkerIndex = -1;
    let slideThumbnails = {}; // Cache for slide thumbnail data URLs

    // DOM Elements
    const pdfInput = document.getElementById('pdfInput');
    const audioInput = document.getElementById('audioInput');
    const pdfName = document.getElementById('pdfName');
    const audioName = document.getElementById('audioName');
    const thumbnails = document.getElementById('thumbnails');
    const slideCanvas = document.getElementById('slideCanvas');
    const audioPlayer = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const speedSelect = document.getElementById('speedSelect');
    const markersList = document.getElementById('markersList');
    const addMarkerBtn = document.getElementById('addMarkerBtn');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const editModal = document.getElementById('editModal');
    const editTime = document.getElementById('editTime');
    const editSlide = document.getElementById('editSlide');
    const editCancel = document.getElementById('editCancel');
    const editSave = document.getElementById('editSave');
    const generateBtn = document.getElementById('generateBtn');

    // Format time
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toFixed(3).padStart(6, '0')}`;
    }

    // Load PDF
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      pdfFile = file;
      pdfName.textContent = file.name;
      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      totalPages = pdfDoc.numPages;

      renderThumbnails();
      renderPage(1);

      // ğŸ”„ è‡ªå‹•ã§PDFåˆ†æã‚’é–‹å§‹
      autoAnalyzePdf();
    });

    // Render thumbnails
    async function renderThumbnails() {
      thumbnails.innerHTML = '';
      slideThumbnails = {}; // Clear cache

      for (let i = 1; i <= totalPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 0.3 });

        const div = document.createElement('div');
        div.className = 'thumbnail' + (i === currentPage ? ' active' : '');
        div.dataset.page = i;

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;

        // Cache thumbnail as data URL for marker list
        slideThumbnails[i] = canvas.toDataURL('image/png');

        const label = document.createElement('div');
        label.className = 'thumbnail-label';
        label.textContent = `${i} / ${totalPages}`;

        div.appendChild(canvas);
        div.appendChild(label);
        div.addEventListener('click', () => {
          currentPage = i;
          renderPage(i);
          updateThumbnailSelection();
        });

        thumbnails.appendChild(div);
      }
    }

    // Update thumbnail selection
    function updateThumbnailSelection() {
      document.querySelectorAll('.thumbnail').forEach((el, idx) => {
        el.classList.toggle('active', idx + 1 === currentPage);
      });
    }

    // Render page
    async function renderPage(pageNum) {
      if (!pdfDoc) return;

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1.5 });

      slideCanvas.width = viewport.width;
      slideCanvas.height = viewport.height;

      const ctx = slideCanvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;
    }

    // Load audio
    audioInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      audioFile = file;
      audioName.textContent = file.name;
      audioPlayer.src = URL.createObjectURL(file);

      // ğŸ”„ è‡ªå‹•ã§éŸ³å£°æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹
      autoTranscribeAudio();
    });

    // Audio events
    audioPlayer.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audioPlayer.duration);
      renderMarkerIndicators();
    });

    audioPlayer.addEventListener('timeupdate', () => {
      const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progressBar.style.width = `${progress}%`;
      currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      updateCurrentMarker();
    });

    audioPlayer.addEventListener('play', () => {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    });

    audioPlayer.addEventListener('pause', () => {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    });

    // Play/Pause
    playBtn.addEventListener('click', togglePlay);

    function togglePlay() {
      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    }

    // Speed
    speedSelect.addEventListener('change', () => {
      audioPlayer.playbackRate = parseFloat(speedSelect.value);
    });

    // Progress seek
    progressContainer.addEventListener('click', (e) => {
      if (!audioPlayer.duration) return;
      const rect = progressContainer.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      audioPlayer.currentTime = ratio * audioPlayer.duration;
    });

    // Add marker
    function addMarker() {
      if (!audioPlayer.duration || !totalPages) {
        alert('PDFã¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }

      const marker = {
        t: audioPlayer.currentTime,
        slide: currentPage
      };

      markers.push(marker);
      markers.sort((a, b) => a.t - b.t);
      renderMarkers();
      renderMarkerIndicators();

      // è‡ªå‹•çš„ã«æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã«é€²ã‚€
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
        updateThumbnailSelection();
      }
    }

    addMarkerBtn.addEventListener('click', addMarker);

    // Render markers list
    function renderMarkers() {
      if (markers.length === 0) {
        markersList.innerHTML = '<div class="empty-state"><p>ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p><p>Mã‚­ãƒ¼ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ã§ãã¾ã™</p></div>';
        return;
      }

      markersList.innerHTML = markers.map((m, i) => `
        <div class="marker-item" data-index="${i}">
          <img class="marker-thumb" src="${slideThumbnails[m.slide] || ''}" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ ${m.slide}">
          <div class="marker-info">
            <span class="marker-time">${formatTime(m.t)}</span>
            <span class="marker-slide">ã‚¹ãƒ©ã‚¤ãƒ‰ ${m.slide}</span>
          </div>
          <div class="marker-actions">
            <button class="edit" title="ç·¨é›†" onclick="openEditModal(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <button class="goto" title="ã“ã®ä½ç½®ã¸ç§»å‹•" onclick="gotoMarker(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="delete" title="å‰Šé™¤" onclick="deleteMarker(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Render marker indicators on progress bar
    function renderMarkerIndicators() {
      document.querySelectorAll('.marker-indicator').forEach(el => el.remove());

      if (!audioPlayer.duration) return;

      markers.forEach(m => {
        const indicator = document.createElement('div');
        indicator.className = 'marker-indicator';
        indicator.style.left = `${(m.t / audioPlayer.duration) * 100}%`;
        progressContainer.appendChild(indicator);
      });
    }

    // Update current marker highlight
    function updateCurrentMarker() {
      const currentTime = audioPlayer.currentTime;
      document.querySelectorAll('.marker-item').forEach((el, i) => {
        const marker = markers[i];
        const nextMarker = markers[i + 1];
        const isCurrent = marker && currentTime >= marker.t && (!nextMarker || currentTime < nextMarker.t);
        el.classList.toggle('current', isCurrent);
      });
    }

    // Go to marker
    window.gotoMarker = function(index) {
      const marker = markers[index];
      if (!marker) return;
      audioPlayer.currentTime = marker.t;
      currentPage = marker.slide;
      renderPage(currentPage);
      updateThumbnailSelection();
    };

    // Delete marker
    window.deleteMarker = function(index) {
      markers.splice(index, 1);
      renderMarkers();
      renderMarkerIndicators();
    };

    // Edit modal
    window.openEditModal = function(index) {
      editingMarkerIndex = index;
      const marker = markers[index];
      editTime.value = marker.t.toFixed(3);
      editSlide.value = marker.slide;
      editSlide.max = totalPages;
      editModal.classList.add('active');
    };

    editCancel.addEventListener('click', () => {
      editModal.classList.remove('active');
      editingMarkerIndex = -1;
    });

    editSave.addEventListener('click', () => {
      if (editingMarkerIndex < 0) return;

      const t = parseFloat(editTime.value);
      const slide = parseInt(editSlide.value);

      if (isNaN(t) || t < 0 || t > audioPlayer.duration) {
        alert('ç„¡åŠ¹ãªæ™‚é–“ã§ã™');
        return;
      }
      if (isNaN(slide) || slide < 1 || slide > totalPages) {
        alert('ç„¡åŠ¹ãªã‚¹ãƒ©ã‚¤ãƒ‰ç•ªå·ã§ã™');
        return;
      }

      markers[editingMarkerIndex] = { t, slide };
      markers.sort((a, b) => a.t - b.t);

      editModal.classList.remove('active');
      editingMarkerIndex = -1;
      renderMarkers();
      renderMarkerIndicators();
    });

    // Export
    exportBtn.addEventListener('click', () => {
      if (markers.length === 0) {
        alert('ä¿å­˜ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const data = { markers: markers };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'markers.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import
    importBtn.addEventListener('click', () => {
      importInput.click();
    });

    importInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data.markers || !Array.isArray(data.markers)) {
          throw new Error('Invalid markers.json format');
        }

        markers = data.markers.map(m => ({
          t: Number(m.t),
          slide: Number(m.slide)
        })).filter(m => !isNaN(m.t) && !isNaN(m.slide) && m.t >= 0 && m.slide >= 1);

        markers.sort((a, b) => a.t - b.t);
        renderMarkers();
        renderMarkerIndicators();
      } catch (err) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      }

      importInput.value = '';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      switch (e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          togglePlay();
          break;
        case 'm':
          e.preventDefault();
          addMarker();
          break;
        case 'arrowleft':
          e.preventDefault();
          audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
          break;
        case 'arrowright':
          e.preventDefault();
          audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
          break;
        case 'arrowup':
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            updateThumbnailSelection();
          }
          break;
        case 'arrowdown':
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            updateThumbnailSelection();
          }
          break;
      }
    });

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && editModal.classList.contains('active')) {
        editModal.classList.remove('active');
        editingMarkerIndex = -1;
      }
    });

    // Loading modal elements
    const loadingModal = document.getElementById('loadingModal');
    const loadingAnimation = document.getElementById('loadingAnimation');
    const aiPanel = document.getElementById('aiPanel');
    const toggleAnimation = document.getElementById('toggleAnimation');
    const toggleAI = document.getElementById('toggleAI');
    const loadingProgress = document.getElementById('loadingProgress');
    const loadingStatus = document.getElementById('loadingStatus');
    const boxesContainer = document.getElementById('boxes');

    // AI elements
    const aiAnalyzeBtn = document.getElementById('aiAnalyzeBtn');
    const aiSummaryBtn = document.getElementById('aiSummaryBtn');
    const aiKeyPointsBtn = document.getElementById('aiKeyPointsBtn');
    const aiQuizBtn = document.getElementById('aiQuizBtn');
    const aiResult = document.getElementById('aiResult');
    const aiCopyBtn = document.getElementById('aiCopyBtn');
    const aiStatus = document.getElementById('aiStatus');
    let pdfAnalyzed = false;

    // Loading state
    let boxCount = 0;
    let progressInterval = null;
    let currentProgress = 0;

    // Show loading modal
    function showLoadingModal() {
      loadingModal.classList.add('active');
      boxCount = 0;
      currentProgress = 0;
      boxesContainer.innerHTML = '';
      loadingProgress.textContent = '0%';
      loadingStatus.textContent = 'æº–å‚™ä¸­...';
      aiResult.innerHTML = '';
      aiCopyBtn.style.display = 'none';

      // Start progress simulation
      progressInterval = setInterval(() => {
        if (currentProgress < 95) {
          currentProgress += Math.random() * 3;
          if (currentProgress > 95) currentProgress = 95;
          updateProgress(Math.floor(currentProgress));
        }
      }, 500);
    }

    // Update progress
    function updateProgress(percent) {
      loadingProgress.textContent = `${percent}%`;

      // Update status text based on progress
      if (percent < 20) {
        loadingStatus.textContent = 'PDFã‚’å¤‰æ›ä¸­...';
      } else if (percent < 50) {
        loadingStatus.textContent = 'ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’ç”Ÿæˆä¸­...';
      } else if (percent < 80) {
        loadingStatus.textContent = 'å‹•ç”»ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...';
      } else {
        loadingStatus.textContent = 'éŸ³å£°ã‚’åˆæˆä¸­...';
      }

      // Add boxes based on progress
      const targetBoxes = Math.floor(percent / 5);
      while (boxCount < targetBoxes && boxCount < 20) {
        addBox();
      }
    }

    // Add a box to the container
    function addBox() {
      const box = document.createElement('div');
      box.className = 'box';
      box.style.animationDelay = `${Math.random() * 0.2}s`;
      boxesContainer.appendChild(box);
      boxCount++;
    }

    // Hide loading modal
    function hideLoadingModal() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      loadingModal.classList.remove('active');
    }

    // Complete progress
    function completeProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      updateProgress(100);
      loadingStatus.textContent = 'å®Œäº†ï¼';
    }

    // Toggle between animation and AI panel
    toggleAnimation.addEventListener('click', () => {
      loadingAnimation.style.display = 'block';
      aiPanel.classList.remove('active');
      toggleAnimation.classList.add('active');
      toggleAI.classList.remove('active');
    });

    toggleAI.addEventListener('click', () => {
      loadingAnimation.style.display = 'none';
      aiPanel.classList.add('active');
      toggleAnimation.classList.remove('active');
      toggleAI.classList.add('active');
    });

    // AI functions
    async function callAI(type) {
      const button = type === 'summary' ? aiSummaryBtn :
                     type === 'keypoints' ? aiKeyPointsBtn : aiQuizBtn;

      button.disabled = true;
      button.classList.add('loading');
      aiResult.innerHTML = '<p>ç”Ÿæˆä¸­...</p>';
      aiCopyBtn.style.display = 'none';

      try {
        const response = await fetch(`/api/ai/${type}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pdfName: pdfFile?.name || '',
            audioName: audioFile?.name || '',
            slideCount: totalPages,
            markers: markers,
            duration: audioPlayer.duration || 0
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'AIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        aiResult.innerHTML = `<h4>${data.title}</h4><p>${data.content}</p>`;
        aiCopyBtn.style.display = 'block';
      } catch (error) {
        if (error.message.includes('API key') || error.message.includes('OPENAI')) {
          aiResult.innerHTML = '<p>APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>.envãƒ•ã‚¡ã‚¤ãƒ«ã«OPENAI_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>';
        } else {
          aiResult.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      } finally {
        button.disabled = false;
        button.classList.remove('loading');
      }
    }

    // PDFåˆ†æï¼ˆGeminiï¼‰
    aiAnalyzeBtn.addEventListener('click', async () => {
      if (!pdfFile) {
        aiResult.innerHTML = '<p>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>';
        return;
      }

      aiAnalyzeBtn.disabled = true;
      aiAnalyzeBtn.classList.add('loading');
      aiResult.innerHTML = '<p>PDFã‚’åˆ†æä¸­... (å„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™)</p>';
      aiCopyBtn.style.display = 'none';

      try {
        const formData = new FormData();
        formData.append('pdf', pdfFile);

        const response = await fetch('/api/ai/analyze', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'PDFåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        pdfAnalyzed = true;
        aiAnalyzeBtn.classList.add('done');
        aiAnalyzeBtn.textContent = 'åˆ†æå®Œäº† âœ“';
        aiStatus.textContent = `${data.slideCount}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’åˆ†æã—ã¾ã—ãŸ`;
        aiStatus.classList.add('analyzed');

        // çµæœã‚’è¡¨ç¤º
        const summaryText = data.summaries.map(s =>
          `ã€ã‚¹ãƒ©ã‚¤ãƒ‰${s.slide}ã€‘\n${s.summary}`
        ).join('\n\n');
        aiResult.innerHTML = `<h4>ã‚¹ãƒ©ã‚¤ãƒ‰è¦ç´„</h4><p>${summaryText.replace(/\n/g, '<br>')}</p>`;
        aiCopyBtn.style.display = 'block';
      } catch (error) {
        if (error.message.includes('GEMINI')) {
          aiResult.innerHTML = '<p>GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>.envãƒ•ã‚¡ã‚¤ãƒ«ã«GEMINI_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>';
        } else {
          aiResult.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      } finally {
        aiAnalyzeBtn.disabled = false;
        aiAnalyzeBtn.classList.remove('loading');
      }
    });

    aiSummaryBtn.addEventListener('click', () => callAI('summary'));
    aiKeyPointsBtn.addEventListener('click', () => callAI('keypoints'));
    aiQuizBtn.addEventListener('click', () => callAI('quiz'));

    // Copy AI result
    aiCopyBtn.addEventListener('click', () => {
      const text = aiResult.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const originalText = aiCopyBtn.textContent;
        aiCopyBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        setTimeout(() => {
          aiCopyBtn.textContent = originalText;
        }, 2000);
      });
    });

    // Auto Marker Generation (è‡ªå‹•å‡¦ç†ç‰ˆ)
    const autoGenerateBtn = document.getElementById('autoGenerateBtn');
    const autoMarkerStatus = document.getElementById('autoMarkerStatus');
    const autoProgress = document.getElementById('autoProgress');
    const pdfProgress = document.getElementById('pdfProgress');
    const audioProgress = document.getElementById('audioProgress');
    const pdfProgressIcon = document.getElementById('pdfProgressIcon');
    const audioProgressIcon = document.getElementById('audioProgressIcon');
    const pdfProgressText = document.getElementById('pdfProgressText');
    const audioProgressText = document.getElementById('audioProgressText');

    let pdfAnalyzedForAuto = false;
    let audioTranscribed = false;
    let pdfAnalyzing = false;
    let audioTranscribing = false;

    // Update auto generate button state
    function updateAutoGenerateState() {
      const ready = pdfAnalyzedForAuto && audioTranscribed;
      const processing = pdfAnalyzing || audioTranscribing;

      autoGenerateBtn.disabled = !ready || processing;

      // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      if (ready && !processing) {
        autoMarkerStatus.textContent = 'âœ… æº–å‚™å®Œäº†ï¼ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆ';
        autoMarkerStatus.className = 'auto-status ready';
      } else if (processing) {
        if (pdfAnalyzing && audioTranscribing) {
          autoMarkerStatus.textContent = 'ğŸ”„ PDFã¨éŸ³å£°ã‚’åŒæ™‚ã«AIåˆ†æä¸­...';
        } else if (pdfAnalyzing) {
          autoMarkerStatus.textContent = 'ğŸ”„ PDFã‚’AIåˆ†æä¸­... éŸ³å£°ã‚‚é¸æŠã—ã¦ãã ã•ã„';
        } else if (audioTranscribing) {
          autoMarkerStatus.textContent = 'ğŸ”„ éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
        }
        autoMarkerStatus.className = 'auto-status';
      } else if (pdfAnalyzedForAuto && !audioTranscribed) {
        autoMarkerStatus.textContent = 'ğŸ“‚ PDFåˆ†æå®Œäº†ï¼éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
        autoMarkerStatus.className = 'auto-status';
      } else if (!pdfAnalyzedForAuto && audioTranscribed) {
        autoMarkerStatus.textContent = 'ğŸ“‚ éŸ³å£°åˆ†æå®Œäº†ï¼PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
        autoMarkerStatus.className = 'auto-status';
      } else {
        autoMarkerStatus.textContent = 'ğŸ“‚ PDFã¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
        autoMarkerStatus.className = 'auto-status';
      }
    }

    // è‡ªå‹•PDFåˆ†æï¼ˆPDFèª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
    async function autoAnalyzePdf() {
      if (!pdfFile || pdfAnalyzing || pdfAnalyzedForAuto) return;

      pdfAnalyzing = true;
      pdfProgress.className = 'progress-item processing';
      pdfProgressIcon.textContent = 'â³';
      pdfProgressText.textContent = 'PDFåˆ†æä¸­...ï¼ˆGemini AIï¼‰';
      updateAutoGenerateState();

      try {
        const formData = new FormData();
        formData.append('pdf', pdfFile);

        const response = await fetch('/api/ai/analyze', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'PDFåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        pdfAnalyzedForAuto = true;
        pdfAnalyzed = true;
        pdfProgress.className = 'progress-item done';
        pdfProgressIcon.textContent = 'âœ…';
        pdfProgressText.textContent = `PDFåˆ†æå®Œäº†ï¼ˆ${data.slideCount}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰`;

        // AI panel state update
        if (aiAnalyzeBtn) {
          aiAnalyzeBtn.classList.add('done');
          aiAnalyzeBtn.textContent = 'åˆ†æå®Œäº† âœ“';
        }
        if (aiStatus) {
          aiStatus.textContent = `${data.slideCount}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’åˆ†æã—ã¾ã—ãŸ`;
          aiStatus.classList.add('analyzed');
        }

      } catch (error) {
        pdfProgress.className = 'progress-item error';
        pdfProgressIcon.textContent = 'âŒ';
        pdfProgressText.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      } finally {
        pdfAnalyzing = false;
        updateAutoGenerateState();
      }
    }

    // è‡ªå‹•éŸ³å£°æ–‡å­—èµ·ã“ã—ï¼ˆéŸ³å£°èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
    async function autoTranscribeAudio() {
      if (!audioFile || audioTranscribing || audioTranscribed) return;

      audioTranscribing = true;
      audioProgress.className = 'progress-item processing';
      audioProgressIcon.textContent = 'â³';
      audioProgressText.textContent = 'éŸ³å£°æ–‡å­—èµ·ã“ã—ä¸­...ï¼ˆWhisper AIï¼‰';
      updateAutoGenerateState();

      try {
        const formData = new FormData();
        formData.append('audio', audioFile);

        const response = await fetch('/api/ai/transcribe', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        audioTranscribed = true;
        audioProgress.className = 'progress-item done';
        audioProgressIcon.textContent = 'âœ…';
        audioProgressText.textContent = `éŸ³å£°æ–‡å­—èµ·ã“ã—å®Œäº†ï¼ˆ${Math.round(data.duration)}ç§’ã®éŸ³å£°ï¼‰`;

      } catch (error) {
        audioProgress.className = 'progress-item error';
        audioProgressIcon.textContent = 'âŒ';
        audioProgressText.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      } finally {
        audioTranscribing = false;
        updateAutoGenerateState();
      }
    }

    // Auto Generate Markers
    autoGenerateBtn.addEventListener('click', async () => {
      if (!pdfAnalyzedForAuto || !audioTranscribed) {
        autoMarkerStatus.textContent = 'â³ PDFã¨éŸ³å£°ã®åˆ†æå®Œäº†ã‚’å¾…ã£ã¦ã„ã¾ã™...';
        return;
      }

      autoGenerateBtn.disabled = true;
      autoGenerateBtn.classList.add('loading');
      autoMarkerStatus.innerHTML = 'ğŸ¤– <strong>AIãŒã‚¹ãƒ©ã‚¤ãƒ‰ã¨éŸ³å£°ã‚’ãƒãƒƒãƒãƒ³ã‚°ä¸­...</strong><br><small>GPT-5.2ãŒã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</small>';
      autoMarkerStatus.className = 'auto-status';

      try {
        const response = await fetch('/api/ai/auto-markers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ãƒãƒ¼ã‚«ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedMarkers = [...data.markers].sort((a, b) => a.t - b.t);

        // ç›´æ¥ãƒãƒ¼ã‚«ãƒ¼ã‚’é©ç”¨ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã—ï¼‰
        markers = sortedMarkers;
        renderMarkers();
        renderMarkerIndicators();

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        autoMarkerStatus.innerHTML = `ğŸ‰ <strong>${sortedMarkers.length}å€‹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸï¼</strong><br><small>ä¸‹ã®ãƒªã‚¹ãƒˆã§ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™</small>`;
        autoMarkerStatus.className = 'auto-status ready';

        // ç°¡å˜ãªé€šçŸ¥
        alert(`âœ… ${sortedMarkers.length}å€‹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nä¸‹ã®ãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚`);

      } catch (error) {
        autoMarkerStatus.innerHTML = `âŒ <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br><small>ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„</small>`;
        autoMarkerStatus.className = 'auto-status error';
      } finally {
        autoGenerateBtn.disabled = false;
        autoGenerateBtn.classList.remove('loading');
        updateAutoGenerateState();
      }
    });

    // Generate video
    generateBtn.addEventListener('click', async () => {
      if (!pdfFile || !audioFile) {
        alert('PDFã¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }

      // éŸ³å£°ã‚’åœæ­¢ã—ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      audioPlayer.pause();
      showLoadingModal();
      generateBtn.disabled = true;

      try {
        const formData = new FormData();
        formData.append('pdf', pdfFile);
        formData.append('audio', audioFile);
        formData.append('markers', JSON.stringify(markers));

        // é•·æ™‚é–“ã®å‹•ç”»ç”Ÿæˆã«å¯¾å¿œã™ã‚‹ãŸã‚ã€10åˆ†ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10 * 60 * 1000); // 10åˆ†

        const response = await fetch('/api/generate', {
          method: 'POST',
          body: formData,
          signal: controller.signal,
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'å‹•ç”»ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // Complete the progress animation
        completeProgress();

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‹ã‚‰å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const a = document.createElement('a');
        a.href = data.downloadUrl;
        a.download = data.filename || 'slidecast-output.mp4';
        a.click();

        const sizeMB = (data.size / 1024 / 1024).toFixed(1);

        // Wait a moment to show completion
        setTimeout(() => {
          hideLoadingModal();
          alert(`å‹•ç”»ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${sizeMB}MB`);
        }, 1000);
      } catch (error) {
        hideLoadingModal();
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      } finally {
        generateBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

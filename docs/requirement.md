# requirement.md — PDF+音声 → MP4自動生成（Slidecast Pipeline）要件定義

## 0. このドキュメントの目的
本リポジトリで実装する「PDFスライド + 音声 → MP4動画」の自動生成ツールについて、
- これまでの経緯（なぜ必要になったか）
- 現状の材料（受領物・東さんの現行フロー）
- 今回の納品範囲（2日納期で必ず成立させる部分）
- 追加提案（将来の“マジックモーメント”の方向性）
を、AIエージェントが理解して実装に着手できるレベルに整理する。

**実装タスクの詳細は Tasks.md を参照**。本書は「仕様と背景・意思決定の根拠」のまとめ。

---

## 1. 背景（Context）
### 1-1. 依頼者（Azumaさん）の課題
- Azumaさんは、自身が作成した学習文書（長文・原稿・教材）を、より多くの人へ届けたい。
- 従来は対面講義や配布資料により提供していたが、提供できる人数は年50人未満、体力的負担も増えてきている。
- 活字だけだと読まれにくい。音声やスライド等の「学習メディア化」により訴求力を高めたい。
- 既存のeラーニング管理システム（約7万人提供）へ搭載して運用したい。最終形はmp4等の形式で配信・管理したい。

### 1-2. NotebookLMでの検証と現在地
- NotebookLMに原稿を投入し、以下のアウトプットが短時間で生成できることを体験済み：
  - レポート（要約/再構成）
  - ポッドキャスト（音声解説）
  - スライド（PDF）
  - テスト / マインドマップ等（今回は主に音声とスライドが対象）
- Azumaさんは既に試行錯誤し、現時点でほぼ満足する品質を得られる手順を確立しつつある。

### 1-3. Azumaさんの現行フロー（本人が試した手順）
1. 生原稿をソースとしてNotebookLMに投入し、**レポート生成**  
   - 生原稿では整理されなかった内容がまとまる  
   - ただし、構成や文脈の編集が必要
2. レポート内容を編集  
   - 使いたい語句／使いたくない語句  
   - 強調したい点／不要な点  
   を修正
3. 編集済レポートをソースとしてNotebookLMへ投入し、**ポッドキャスト（音声）**と**スライド（PDF）**を生成  
   - プロンプトで時間・スライド枚数・構成を調整可能

### 1-4. 現状のボトルネック（今回の解決対象）
- 最後の工程：**音声とスライドを同期して、mp4として完成させる作業**
  - 現状はPowerPoint等で手動調整→mp4書き出しなど、アナログ作業になりがち
- この“最後の同期〜mp4化”を自動化できれば、教材量産の体験価値が大幅に上がる  
  → ここが「今回の実装の本丸」

---

## 2. 今回のゴール（Goal）
### 2-1. 納品として成立させるもの（2日納期の現実的ゴール）
**PDFスライド + 音声（m4a）**を入力として、以下を実現する：

- 1コマンドで **MP4が生成**される
- スライドは「パッパッ」と切り替わる（最低限、等間隔で良い）
- 必要なら、表示秒数を **CSVで手調整できる**
- 「同期作業の90%削減」を確実に実現する

### 2-2. Definition of Done（完了条件）
- 入力：`slides.pdf` と `audio.m4a`
- 出力：`output.mp4`
- MP4は再生でき、音声が最後まで鳴り、スライドが最後まで表示・切替される
- `timings.csv` 指定により、一部スライドだけ長く/短くできる

---

## 3. 受領済み素材（Inputs）
Azumaさんから受領した（本リポジトリの動作検証に使う想定）：
- スライドPDF（例：詳細スライド）
- 音声ファイル（m4a）
- レポート（docx）
- NotebookLMで使用したプロンプト集（docx）

※これらは実装の参考・検証用。実装物は「PDF+音声→MP4」に集中する。

---

## 4. スコープ（Scope）
### 4-1. In Scope（今回やる）
- ローカルCLIツールとして実装（n8nは使わない）
- PDF→PNG化（pdftoppm/poppler）
- 音声長取得（ffprobe）
- 等間隔でスライド切替を決める
- 任意で `timings.csv` による秒数上書き
- ffmpegで動画生成（画像連結→音声合体）
- 依存不足時のエラーメッセージとREADME整備

### 4-2. Out of Scope（今回やらない）
- n8n/Drive/Supabase等のクラウド連携
- GUI、Webアプリ化
- 文字起こし、OCR、意味理解に基づく自動同期
- NotebookLM自体の操作自動化（NotebookLM内部での生成手順の自動化）
- スライドの品質改善（図を綺麗にする等）※別テーマ

---

## 5. 仕様（Functional Requirements）
### FR-1 入力
- `--pdf`：入力PDF（複数ページ）
- `--audio`：入力音声（m4a等、ffmpegで読める形式）
- `--out`：出力MP4パス
- 任意：`--timings`（CSV）

### FR-2 PDF→PNG変換
- popplerの `pdftoppm` を利用
- ページ順が保証される命名（例：`slide-1.png`, `slide-2.png` ...）にする

### FR-3 音声duration取得
- `ffprobe` で秒数（float）取得
- 取得不可ならエラー

### FR-4 切替秒数の計算
- デフォルト：音声長 ÷ スライド枚数（等間隔）
- 合計が音声長と一致するように端数調整（最後に寄せる等）
- `timings.csv` 指定時：
  - 指定分を固定し、残り時間を未指定スライドへ均等配分
  - 指定合計が音声長を超えたらエラー

### FR-5 MP4生成
- 画像をduration付きで連結して動画化
- その動画に音声を合体
- 互換性重視のエンコード（H.264/AAC、yuv420pなど）
- 出力は `--out` に生成

### FR-6 中間生成物
- 変換PNG、concat用ファイルなどを `workdir` に作る
- `--keep-work` で残せると良い（なければデフォルト削除でも可）

---

## 6. 非機能要件（Non-Functional Requirements）
### NFR-1 再現性
- READMEだけで第三者が再現可能（brew install含む）
- 実行手順は「コピペで動く」こと

### NFR-2 安全性・秘匿
- APIキー等は扱わない
- .envや機密は不要

### NFR-3 可搬性（ゆるく）
- macOSで確実に動く（最優先）
- Linuxも可能なら動くが必須ではない
- 依存コマンドが無ければ分かりやすく案内して終了

---

## 7. 運用・コミュニケーションの前提
- 今回は「Azumaさんを最大限満足させる」が最重要  
  → 自前プロダクト化や過剰な作り込みより、確実な成果物を短期で出す
- 追加提案（後述）として高度化は可能だが、まず今回の納品ラインを死守する

---

## 8. 追加提案（将来のアップセル案：99%同期の“マジックモーメント”）
※本スコープ外だが、今回の成果物を踏み台にして次の提案に繋げるための構想。

### 8-1. コンセプト
- PDFの各スライド内容をAIで抽出（テキスト抽出 or OCR）
- 音声をタイムスタンプ付きで文字起こし
- スライド内容と音声内容を突合し、「何分何秒で次スライドへ」timingsを自動推定
- 手直しをほぼ不要にして「99%自動同期」に近づける

### 8-2. 今回との関係
- 今回：等間隔 + CSV調整で **90%削減**
- 次：内容理解ベースで切替を自動推定して **99%に近づける**
- 検証・チューニングが必要なため、**追加費用**の正当性がある

---

## 9. タスクの参照
実装・作業順は `Tasks.md` を参照し、その通りに進めること。
本書は「何を作るべきか（背景と仕様）」の定義である。
